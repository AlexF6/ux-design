---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { Image } from "astro:assets";

export function getStaticPaths() {
  const totalImages = 27;
  return Array.from({ length: totalImages }, (_, i) => {
    const id = String(i + 1).padStart(2, "0");
    return { params: { id } };
  });
}

const { id } = Astro.params as { id: string };
const num = parseInt(id, 10);

const formatNum = (n: number) => n.toString().padStart(2, "0");

if (!Number.isInteger(num) || num < 1 || num > 27) {
  throw new Error(`Invalid image id: ${id}`);
}

const imageFiles = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/webp/*.{jpeg,jpg,png,tiff,webp}",
  { eager: true }
);

const fileName = `image${formatNum(num)}.webp`;
const path = Object.keys(imageFiles).find((key) => key.endsWith(fileName));

if (!path) {
  throw new Error(`Image ${fileName} not found`);
}

const imageAsset = imageFiles[path].default;
---

<BaseLayout title={`Art ${formatNum(num)}`}>
  <main class="l-main">
    <section id="detail-overlay" class="detail-overlay">
      <section class="c-detail">
        <div class="c-detail__image-wrapper">
          <Image
            src={imageAsset}
            alt={`Art ${formatNum(num)}`}
            width={600}
            height={750}
            class="u-img-cover"
            loading="eager"
            fetchpriority="high"
          />
        </div>

        <a href="/" class="c-detail__back">Back to gallery</a>
      </section>
    </section>
  </main>
</BaseLayout>

<style>
  @keyframes slide-in-up {
    from { transform: translateY(100%); }
    to   { transform: translateY(0); }
  }

  @keyframes slide-out-up {
    from { transform: translateY(0); }
    to   { transform: translateY(-100%); }
  }

  .detail-overlay {
    position: fixed;
    inset: 0;
    background-color: var(--system-background-color);
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: center;
    transform: translateY(100%);
  }

  .detail-overlay.is-entering {
    animation: slide-in-up 2s cubic-bezier(0.19, 1, 0.22, 1) forwards;
  }

  .detail-overlay.is-leaving {
    animation: slide-out-up 2s cubic-bezier(0.19, 1, 0.22, 1) forwards;
  }

  .c-detail {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 60px 20px;
    width: 100%;
    height: 100%;
    justify-content: center;
  }

  .c-detail__image-wrapper {
    width: 100%;
    max-width: 600px;
    aspect-ratio: 4 / 5;
    overflow: hidden;
    border-radius: 4px;
    background: #111;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  }

  .u-img-cover {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .c-detail__back {
    margin-top: 30px;
    text-decoration: none;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: white;
    opacity: 0.7;
    transition: opacity 0.3s;
  }

  .c-detail__back:hover {
    opacity: 1;
  }
</style>

<script>
  const overlay = document.getElementById('detail-overlay');

  if (overlay) {
    requestAnimationFrame(() => {
      overlay.classList.add('is-entering');
    });

    const backLink = document.querySelector('.c-detail__back');

    if (backLink) {
      backLink.addEventListener('click', (event) => {
        event.preventDefault();

        const targetHref = (backLink as HTMLAnchorElement).href || '/';

        overlay.classList.remove('is-entering');
        overlay.classList.add('is-leaving');

        const handleAnimationEnd = () => {
          overlay.removeEventListener('animationend', handleAnimationEnd);
          window.location.href = targetHref;
        };

        overlay.addEventListener('animationend', handleAnimationEnd);
      });
    }
  }
</script>
